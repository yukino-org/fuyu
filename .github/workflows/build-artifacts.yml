name: Build (Artifacts)

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    APP_NAME: fuyu
    DART_SDK: beta
    INPUT_PATH: src/main.dart
    OUTPUT_EXE_DIR: bin

jobs:
    build:
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os:
                    - ubuntu-latest
                    - windows-latest
                    - macOS-latest
        steps:
            - uses: actions/checkout@v2

            - uses: dart-lang/setup-dart@v1
              with:
                  sdk: ${{ env.DART_SDK }}

            - uses: actions/github-script@v6
              id: exe-path
              with:
                  result-encoding: string
                  script: |
                      const fs = require("fs");
                      const os = require("os");
                      const path = require("path");

                      const appName = process.env.APP_NAME;
                      const outputExeDir = process.env.OUTPUT_EXE_DIR;
                      await fs.promises.mkdir(outputExeDir, { recursive: true })

                      const suffix = os.platform() === 'win32' ? '.exe' : '';
                      return path.join(outputExeDir, `${appName}${suffix}`);

            - name: ðŸš§ Do prerequisites
              run: |
                  dart pub get
                  dart run ./cli/generate_meta.dart

            - name: ðŸ‘· Build executable
              run: dart compile exe -o ${{ steps.exe-path.outputs.result }} ${{ env.INPUT_PATH }}

            - name: ðŸš€ Upload artifact
              uses: actions/upload-artifact@v3
              with:
                  name: ${{ env.APP_NAME }}-${{ matrix.os }}
                  path: ${{ steps.exe-path.outputs.result }}
